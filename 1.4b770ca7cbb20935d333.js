(window.webpackJsonp=window.webpackJsonp||[]).push([[1],{455:function(e,t,s){"use strict";function n(e,t){return{success:!0,value:e,problems:null!=t?t:[]}}function r(e){return{success:!1,problems:null!=e?e:[]}}function i(e){if(e.success)return e.value;throw new Error(e.problems.join("\n"))}function o(e){return new c(e)}s.d(t,"c",(function(){return n})),s.d(t,"a",(function(){return r})),s.d(t,"d",(function(){return i})),s.d(t,"b",(function(){return o}));class c{constructor(e){this.logger=e,this.problems=[]}add_problem(e,t,s,n){return this.logger.log(e,s,n),this.problems.push({severity:e,ui_message:t}),this}add_result(e){return this.problems.push(...e.problems),this}success(e){return n(e,this.problems)}failure(){return r(this.problems)}}},472:function(e,t,s){"use strict";var n;s.d(t,"d",(function(){return n})),s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return i})),s.d(t,"c",(function(){return o})),s.d(t,"f",(function(){return c})),s.d(t,"e",(function(){return a})),s.d(t,"g",(function(){return u})),function(e){e[e.PosNorm=0]="PosNorm",e[e.PosTex=1]="PosTex",e[e.PosNormTex=2]="PosNormTex"}(n||(n={}));const r=0,i=1,o=2;function c(e){switch(e){case n.PosNorm:return 24;case n.PosTex:return 16;case n.PosNormTex:return 28}}function a(e){switch(e){case n.PosTex:return-1;case n.PosNorm:case n.PosNormTex:return 12}}function u(e){switch(e){case n.PosNorm:return-1;case n.PosTex:return 12;case n.PosNormTex:return 24}}},482:function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return a}));var n=s(455),r=s(23),i=s(27);const o=r.a.get("core/data_formats/parsing/iff");function c(e,t=!1){return u(e,t,[],(e,t,s)=>({type:t,data:e.take(s)}))}function a(e,t=!1){return u(e,t,[],(e,t,s)=>({type:t,size:s}))}function u(e,t,s,r){const c=Object(n.b)(o);let a=!1;for(;e.bytes_left>=8;){const n=e.u32(),o=e.position,u=e.u32();if(u>e.bytes_left){a=!0,t||c.add_problem(0===s.length?i.b.Error:i.b.Warning,"Invalid IFF format.",`Size ${u} was too large (only ${e.bytes_left} bytes left) at position ${o}.`);break}s.push(r(e,n,u))}return a&&0===s.length?c.failure():c.success(s)}},487:function(e,t,s){"use strict";s.d(t,"a",(function(){return m})),s.d(t,"b",(function(){return x})),s.d(t,"c",(function(){return g})),s.d(t,"d",(function(){return w})),s.d(t,"e",(function(){return y}));var n=s(482),r=s(23);const i=r.a.get("core/data_formats/parsing/ninja/njcm");var o;function c(e,t){const s=e.u32(),n=e.u32(),r=e.vec3_f32(),i=e.f32(),c=[],u=[];if(s){e.seek_start(s);for(const s of a(e,t,!0))if(s.type===o.Vertex)for(const e of s.vertices)c[e.index]={position:e.position,normal:e.normal,bone_weight:e.bone_weight,bone_weight_status:e.bone_weight_status,calc_continue:e.calc_continue}}if(n){e.seek_start(n);let s=void 0,r=void 0,i=void 0;for(const n of a(e,t,!1))switch(n.type){case o.Bits:r=n.src_alpha,i=n.dst_alpha;break;case o.Tiny:s=n.texture_id;break;case o.Material:r=n.src_alpha,i=n.dst_alpha;break;case o.Strip:for(const e of n.triangle_strips)e.texture_id=s,e.src_alpha=r,e.dst_alpha=i;u.push(...n.triangle_strips)}}return{type:"njcm",vertices:c,meshes:u,collision_sphere_center:r,collision_sphere_radius:i}}function a(e,t,s){const n=[];let r=!0;for(;r;){const c=e.u8(),l=e.u8(),_=e.position;let d=0;if(0===c)n.push({type:o.Null,type_id:c});else if(1<=c&&c<=3)n.push({type:o.Bits,type_id:c,src_alpha:l>>>3&7,dst_alpha:7&l});else if(4===c){const s=l,i=e.position;n.push({type:o.CachePolygonList,type_id:c,cache_index:s,offset:i}),t[s]=i,r=!1}else if(5===c){const r=l,i=t[r];null!=i&&(e.seek_start(i),n.push(...a(e,t,s))),n.push({type:o.DrawPolygonList,type_id:c,cache_index:r})}else if(8<=c&&c<=9){d=2;const t=e.u16();n.push({type:o.Tiny,type_id:c,flip_u:0!=(128&c),flip_v:0!=(64&c),clamp_u:0!=(32&c),clamp_v:0!=(16&c),mipmap_d_adjust:15&c,filter_mode:t>>>14,super_sample:0!=(64&t),texture_id:8191&t})}else if(17<=c&&c<=31){let t,s,r;d=2+2*e.u16(),0!=(1&l)&&(t={b:e.u8()/255,g:e.u8()/255,r:e.u8()/255,a:e.u8()/255}),0!=(2&l)&&(s={b:e.u8()/255,g:e.u8()/255,r:e.u8()/255,a:e.u8()/255}),0!=(4&l)&&(r={b:e.u8(),g:e.u8(),r:e.u8(),e:e.u8()}),n.push({type:o.Material,type_id:c,src_alpha:l>>>3&7,dst_alpha:7&l,diffuse:t,ambient:s,specular:r})}else 32<=c&&c<=50?(d=2+4*e.u16(),n.push({type:o.Vertex,type_id:c,vertices:u(e,c,l)})):56<=c&&c<=58?(d=2+2*e.u16(),n.push({type:o.Volume,type_id:c})):64<=c&&c<=75?(d=2+2*e.u16(),n.push({type:o.Strip,type_id:c,triangle_strips:h(e,c,l)})):255===c?(d=s?2:0,n.push({type:o.End,type_id:c}),r=!1):(d=2+2*e.u16(),n.push({type:o.Unknown,type_id:c}),i.warn(`Unknown chunk type ${c} at offset ${_}.`));e.seek_start(_+d)}return n}function u(e,t,s){if(t<32||t>50)return i.warn(`Unknown vertex chunk type ${t}.`),[];const n=3&s,r=0!=(128&s),o=e.u16(),c=e.u16(),a=[];for(let s=0;s<c;++s){const i={index:o+s,position:e.vec3_f32(),bone_weight:1,bone_weight_status:n,calc_continue:r};if(32===t)e.seek(4);else if(33===t)e.seek(4),i.normal=e.vec3_f32(),e.seek(4);else if(35<=t&&t<=40)37===t?(i.index=o+e.u16(),i.bone_weight=e.u16()/255):e.seek(4);else if(41<=t&&t<=47)i.normal=e.vec3_f32(),t>=42&&(44===t?(i.index=o+e.u16(),i.bone_weight=e.u16()/255):e.seek(4));else if(48<=t&&t<=50){const s=e.u32();i.normal={x:(s>>20&1023)/1023,y:(s>>10&1023)/1023,z:(1023&s)/1023},t>=49&&e.seek(4)}a.push(i)}return a}function h(e,t,s){const n={ignore_light:0!=(1&s),ignore_specular:0!=(2&s),ignore_ambient:0!=(4&s),use_alpha:0!=(8&s),double_side:0!=(16&s),flat_shading:0!=(32&s),environment_mapping:0!=(64&s)},r=e.u16(),i=r>>>14,o=16383&r;let c=!1,a=!1,u=!1,h=!1;switch(t){case 64:break;case 65:case 66:c=!0;break;case 67:u=!0;break;case 68:case 69:c=!0,u=!0;break;case 70:a=!0;break;case 71:case 72:c=!0,a=!0;break;case 73:break;case 74:case 75:h=!0;break;default:throw new Error(`Unexpected chunk type ID: ${t}.`)}const l=[];for(let t=0;t<o;++t){const t=e.i16(),s=t<1,r=Math.abs(t),o=[];for(let t=0;t<r;++t){const s={index:e.u16()};o.push(s),c&&(s.tex_coords={x:e.u16()/255,y:e.u16()/255}),a&&e.seek(4),u&&(s.normal={x:e.u16()/255,y:e.u16()/255,z:e.u16()/255}),h&&e.seek(8),t>=2&&e.seek(2*i)}l.push(Object.assign(Object.assign({},n),{clockwise_winding:s,has_tex_coords:c,has_normal:u,vertices:o}))}return l}!function(e){e[e.Unknown=0]="Unknown",e[e.Null=1]="Null",e[e.Bits=2]="Bits",e[e.CachePolygonList=3]="CachePolygonList",e[e.DrawPolygonList=4]="DrawPolygonList",e[e.Tiny=5]="Tiny",e[e.Material=6]="Material",e[e.Vertex=7]="Vertex",e[e.Volume=8]="Volume",e[e.Strip=9]="Strip",e[e.End=10]="End"}(o||(o={}));const l=r.a.get("core/data_formats/parsing/ninja/xj");function _(e){e.seek(4);const t=e.u32(),s=e.u32(),n=e.u32(),r=e.u32(),i=e.u32(),o=e.u32(),c={type:"xj",vertices:[],meshes:[],collision_sphere_position:e.vec3_f32(),collision_sphere_radius:e.f32()};return s>=1&&(s>1&&l.warn(`Vertex info count of ${s} was larger than expected.`),c.vertices.push(...function(e,t){e.seek_start(t);const s=e.u16();e.seek(2);const n=e.u32(),r=e.u32(),i=e.u32(),o=[];for(let t=0;t<i;++t){e.seek_start(n+t*r);const i=e.vec3_f32();let c,a;switch(s){case 3:c=e.vec3_f32(),a=e.vec2_f32();break;case 4:break;case 5:e.seek(4),a=e.vec2_f32();break;case 6:c=e.vec3_f32();break;case 7:c=e.vec3_f32(),a=e.vec2_f32();break;default:l.warn(`Unknown vertex type ${s} with size ${r}.`)}o.push({position:i,normal:c,uv:a})}return o}(e,t))),c.meshes.push(...d(e,n,r)),c.meshes.push(...d(e,i,o)),c}function d(e,t,s){const n=[];for(let r=0;r<s;++r){e.seek_start(t+20*r);const s=e.u32(),i=e.u32(),o=e.u32(),c=e.u32(),a=f(e,s,i);e.seek_start(o);const u=e.u16_array(c);n.push({material_properties:a,indices:u})}return n}function f(e,t,s){const n={};for(let r=0;r<s;++r){switch(e.seek_start(t+16*r),e.u32()){case 2:n.src_alpha=e.u32(),n.dst_alpha=e.u32();break;case 3:n.texture_id=e.u32();break;case 5:n.diffuse_r=e.u8(),n.diffuse_g=e.u8(),n.diffuse_b=e.u8(),n.diffuse_a=e.u8()}}return n}var p=s(455);const m=2*Math.PI/65535,b=1296255566;function x(e){return"njcm"===e.type}class v{constructor(e,t,s,n,r,i){this.evaluation_flags=e,this.model=t,this.position=s,this.rotation=n,this.scale=r,this._children=i,this.children=this._children}bone_count(){const e=[0];return this.get_bone_internal(this,Number.MAX_SAFE_INTEGER,e),e[0]}get_bone(e){return this.get_bone_internal(this,e,[0])}add_child(e){this._children.push(e)}clear_children(){this._children.splice(0)}get_bone_internal(e,t,s){if(!e.evaluation_flags.skip){if(s[0]++===t)return e}if(!e.evaluation_flags.break_child_trace)for(const n of e.children){const e=this.get_bone_internal(n,t,s);if(e)return e}}}function g(e){return k(e,c,[])}function w(e){return k(e,_,void 0)}function y(e){return j(e,_,void 0)}function k(e,t,s){const r=Object(n.a)(e);if(!r.success)return r;const i=r.value.filter(e=>e.type===b),o=[];for(const e of i)o.push(...j(e.data,t,s));return Object(p.c)(o,r.problems)}function j(e,t,s){const n=e.u32(),r=0!=(1&n),i=0!=(2&n),o=0!=(4&n),c=0!=(8&n),a=0!=(16&n),u=0!=(32&n),h=0!=(64&n),l=0!=(128&n),_=e.u32(),d=e.vec3_f32(),f={x:e.i32()*m,y:e.i32()*m,z:e.i32()*m},p=e.vec3_f32(),b=e.u32(),x=e.u32();let g,w,y;return _&&(e.seek_start(_),g=t(e,s)),b?(e.seek_start(b),w=j(e,t,s)):w=[],x?(e.seek_start(x),y=j(e,t,s)):y=[],[new v({no_translate:r,no_rotate:i,no_scale:o,hidden:c,break_child_trace:a,zxy_rotation_order:u,skip:h,shape_skip:l},g,d,f,p,w),...y]}},517:function(e,t,s){"use strict";s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return o}));var n=s(136),r=s(463);function i(e){return new n.Vector3(e.x,e.y,e.z)}function o(e){return new r.c(e.x,e.y,e.z)}},519:function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return i}));var n=s(463);class r{constructor(){this.root_node=new i(void 0,n.a.identity())}traverse(e,t){this.traverse_node(this.root_node,e,t)}traverse_node(e,t,s){const n=t(e,s);for(const s of e.children)this.traverse_node(s,t,n)}}class i{constructor(e,t,...s){this.mesh=e,this.transform=t,this._children=s}get children(){return this._children}add_child(e){this._children.push(e)}clear_children(){this._children.splice(0)}}},654:function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(472);class r{constructor(e){this.format=e,this.vertex_data=[],this.index_data=[]}get vertex_count(){return this.vertex_data.length}triangle(e,t,s){return this.index_data.push(e,t,s),this}build(){const e=Object(n.f)(this.format),t=Object(n.e)(this.format),s=Object(n.g)(this.format),r=new ArrayBuffer(this.vertex_data.length*e),i=new DataView(r);let o=0;for(const{pos:n,normal:r,tex:c}of this.vertex_data)i.setFloat32(o,n.x,!0),i.setFloat32(o+4,n.y,!0),i.setFloat32(o+8,n.z,!0),-1!==t&&(i.setFloat32(o+t,r.x,!0),i.setFloat32(o+t+4,r.y,!0),i.setFloat32(o+t+8,r.z,!0)),-1!==s&&(i.setUint16(o+s,65535*c.x,!0),i.setUint16(o+s+2,65535*c.y,!0)),o+=e;const c=new Uint16Array(2*Math.ceil(this.index_data.length/2));return c.set(this.index_data),new a(this.format,r,c,this.index_data.length,this._texture)}}class i extends r{constructor(){super(n.d.PosNorm)}vertex(e,t){return this.vertex_data.push({pos:e,normal:t}),this}}class o extends r{constructor(){super(n.d.PosTex)}vertex(e,t){return this.vertex_data.push({pos:e,tex:t}),this}texture(e){return this._texture=e,this}}class c extends r{constructor(){super(n.d.PosNormTex)}vertex(e,t,s){return this.vertex_data.push({pos:e,normal:t,tex:s}),this}texture(e){return this._texture=e,this}}class a{constructor(e,t,s,n,r){this.format=e,this.vertex_data=t,this.index_data=s,this.index_count=n,this.texture=r}static builder(e){switch(e){case n.d.PosNorm:return new i;case n.d.PosTex:return new o;case n.d.PosNormTex:return new c}}upload(e){var t;null===(t=this.texture)||void 0===t||t.upload(),null==this.gfx_mesh&&(this.gfx_mesh=e.create_gfx_mesh(this.format,this.vertex_data,this.index_data,this.texture))}destroy(e){e.destroy_gfx_mesh(this.gfx_mesh)}}},906:function(e,t,s){"use strict";s.r(t),s.d(t,"ModelGfxRenderer",(function(){return x}));var n,r=s(15),i=s(487),o=s(517),c=s(654),a=s(472);!function(e){e[e.ZXY=0]="ZXY",e[e.ZYX=1]="ZYX"}(n||(n={}));class u{constructor(e,t,s,n){this.w=e,this.x=t,this.y=s,this.z=n}static euler_angles(e,t,s,r){const i=Math.cos(.5*e),o=Math.sin(.5*e),c=Math.cos(.5*t),a=Math.sin(.5*t),h=Math.cos(.5*s),l=Math.sin(.5*s);switch(r){case n.ZXY:return new u(i*c*h-o*a*l,o*c*h-i*a*l,i*a*h+o*c*l,i*c*l+o*a*h);case n.ZYX:return new u(i*c*h+o*a*l,o*c*h-i*a*l,i*a*h+o*c*l,i*c*l-o*a*h)}}conjugate(){this.x*=-1,this.y*=-1,this.z*=-1}}var h=s(463);const l=new h.c(0,1,0),_=new h.c(0,0,0),d=new u(1,0,0,0),f=new h.c(1,1,1);class p{constructor(){this.vertices_stack=[]}put(e){this.vertices_stack.push(e)}get(e){const t=[];for(let s=this.vertices_stack.length-1;s>=0;s--){const n=this.vertices_stack[s][e];n&&t.push(n)}return t}}class m{constructor(){this.vertices=new p,this.builder=c.a.builder(a.d.PosNorm)}to_mesh(e){return this.object_to_mesh(e,h.a.identity()),this.builder.build()}object_to_mesh(e,t){const{no_translate:s,no_rotate:r,no_scale:i,hidden:c,break_child_trace:a,zxy_rotation_order:l}=e.evaluation_flags,{position:p,rotation:m,scale:b}=e,x=Object(h.e)(t,h.a.compose(s?_:Object(o.a)(p),r?d:u.euler_angles(m.x,m.y,m.z,l?n.ZXY:n.ZYX),i?f:Object(o.a)(b)));if(e.model&&!c&&this.model_to_mesh(e.model,x),!a)for(const t of e.children)this.object_to_mesh(t,x)}model_to_mesh(e,t){Object(i.b)(e)?this.njcm_model_to_mesh(e,t):this.xj_model_to_mesh(e,t)}njcm_model_to_mesh(e,t){var s;const n=t.normal_mat3(),r=e.vertices.map(e=>{const s=Object(o.a)(e.position);Object(h.f)(t,s,s);let r=void 0;return e.normal&&(r=Object(o.a)(e.normal),Object(h.d)(n,r,r)),{position:s,normal:r,bone_weight:e.bone_weight,bone_weight_status:e.bone_weight_status,calc_continue:e.calc_continue}});this.vertices.put(r);for(const t of e.meshes)for(let e=0;e<t.vertices.length;++e){const n=t.vertices[e],r=this.vertices.get(n.index);if(r.length){const i=r[0],c=null!==(s=i.normal)&&void 0!==s?s:n.normal?Object(o.a)(n.normal):l,a=this.builder.vertex_count;this.builder.vertex(i.position,c),e>=2&&(e%2==(t.clockwise_winding?1:0)?this.builder.triangle(a-2,a-1,a):this.builder.triangle(a-2,a,a-1))}}}xj_model_to_mesh(e,t){const s=this.builder.vertex_count,n=t.normal_mat3();for(const{position:s,normal:r}of e.vertices){const e=Object(o.a)(s);Object(h.f)(t,e,e);const i=r?Object(o.a)(r):new h.c(0,1,0);Object(h.d)(n,i,i),this.builder.vertex(e,i)}for(const t of e.meshes){let e=!1;for(let n=2;n<t.indices.length;++n){const r=s+t.indices[n-2],i=s+t.indices[n-1],o=s+t.indices[n];e?this.builder.triangle(i,r,o):this.builder.triangle(r,i,o),e=!e}}}}var b=s(519);class x{constructor(e,t){this.store=e,this.renderer=t,this.disposer=new r.a,this.nj_object_or_xvm_changed=()=>{this.renderer.destroy_scene();const e=this.store.current_nj_object.val;if(e){const t=new b.b(function(e){return(new m).to_mesh(e)}(e),h.a.identity());this.renderer.scene.root_node.add_child(t),this.renderer.scene.traverse(e=>{var t;null===(t=e.mesh)||void 0===t||t.upload(this.renderer.gfx)},void 0)}this.renderer.schedule_render()},this.canvas_element=t.canvas_element,t.camera.pan(0,0,50),this.disposer.add_all(e.current_nj_object.observe(this.nj_object_or_xvm_changed))}dispose(){this.disposer.dispose()}start_rendering(){this.renderer.start_rendering()}stop_rendering(){this.renderer.stop_rendering()}set_size(e,t){this.renderer.set_size(e,t)}}}}]);