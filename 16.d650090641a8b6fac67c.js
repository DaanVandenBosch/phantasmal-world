(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{453:function(t,e,n){"use strict";function i(t,...e){return{success:!0,value:t,problems:e}}function s(...t){return{success:!1,problems:t}}function r(t,e){return{severity:t,ui_message:e}}function a(t){if(t.success)return t.value;throw new Error(t.problems.join("\n"))}n.d(e,"d",(function(){return i})),n.d(e,"b",(function(){return s})),n.d(e,"c",(function(){return r})),n.d(e,"e",(function(){return a})),n.d(e,"a",(function(){return o}));class o{constructor(t){this.logger=t,this.problems=[]}add_problem(t,e,n,i){return this.logger.log(t,null!=n?n:e,i),this.problems.push({severity:t,ui_message:e}),this}add_result(t){return this.problems.push(...t.problems),this}success(t){return i(t,...this.problems)}failure(){return s(...this.problems)}}},491:function(t,e,n){"use strict";n.d(e,"a",(function(){return s})),n.d(e,"b",(function(){return r})),n.d(e,"c",(function(){return a}));var i=n(464);var s,r;function a(t,e){return 1296321870===t.u32()?function(t,e){const n=t.u32();return o(t.take(n),e)}(t,e):(t.seek_start(0),function(t,e){t.seek_end(16);const n=t.u32();t.seek_start(n);const i=t.u32();return t.seek_start(i),function(t,e){t.seek(4);const n=t.u32();return t.seek_start(n),o(t,e)}(t,e)}(t,e))}function o(t,e){let n=t.u32();const i=t.u32(),s=t.u16(),a=t.u16(),o=(192&a)>>6,u=15&a,l=[];for(let a=0;a<e;a++){t.seek_start(n),n=n+=8*u;const e={tracks:[]};l.push(e);const a=[],o=[];for(let e=0;e<u;e++)a.push(t.u32());for(let e=0;e<u;e++){const e=t.u32();o.push(e)}if(1&s){t.seek_start(a.shift());const n=o.shift();n&&e.tracks.push({type:r.Position,keyframes:c(t,n)})}if(2&s){t.seek_start(a.shift());const n=o.shift();n&&e.tracks.push({type:r.Rotation,keyframes:h(t,n,i)})}if(4&s){t.seek_start(a.shift());const n=o.shift();n&&e.tracks.push({type:r.Scale,keyframes:c(t,n)})}}return{motion_data:l,frame_count:i,type:s,interpolation:o,element_count:u}}function c(t,e){const n=[];for(let i=0;i<e;++i)n.push({frame:t.u32(),value:t.vec3_f32()});return n}function h(t,e,n){const s=[],r=t.position;for(let n=0;n<e;++n)s.push({frame:t.u16(),value:{x:Object(i.a)(t.u16()),y:Object(i.a)(t.u16()),z:Object(i.a)(t.u16())}});let a=-1;for(const{frame:i}of s){if(i<a||i>=n)return t.seek_start(r),u(t,e);a=i}return s}function u(t,e){const n=[];for(let s=0;s<e;++s)n.push({frame:t.u32(),value:{x:Object(i.a)(t.i32()),y:Object(i.a)(t.i32()),z:Object(i.a)(t.i32())}});return n}!function(t){t[t.Linear=0]="Linear",t[t.Spline=1]="Spline",t[t.UserFunction=2]="UserFunction"}(s||(s={})),function(t){t[t.Position=0]="Position",t[t.Rotation=1]="Rotation",t[t.Scale=2]="Scale"}(r||(r={}))},512:function(t,e,n){"use strict";n.d(e,"a",(function(){return o})),n.d(e,"b",(function(){return c}));var i=n(453),s=n(24),r=n(28);const a=s.a.get("core/data_formats/parsing/iff");function o(t,e=!1){return h(t,e,[],(t,e,n)=>({type:e,data:t.take(n)}))}function c(t,e=!1){return h(t,e,[],(t,e,n)=>({type:e,size:n}))}function h(t,e,n,s){const o=new i.a(a);let c=!1;for(;t.bytes_left>=8;){const i=t.u32(),a=t.position,h=t.u32();if(h>t.bytes_left){c=!0,e||o.add_problem(0===n.length?r.b.Error:r.b.Warning,"Invalid IFF format.",`Size ${h} was too large (only ${t.bytes_left} bytes left) at position ${a}.`);break}n.push(s(t,i,h))}return c&&0===n.length?o.failure():o.success(n)}},545:function(t,e,n){"use strict";n.d(e,"a",(function(){return r})),n.d(e,"b",(function(){return a}));var i=n(136),s=n(491);const r=30;function a(t,e){const n=e.interpolation===s.a.Spline?i.InterpolateSmooth:i.InterpolateLinear,a=[];return e.motion_data.forEach((e,o)=>{const c=t.get_bone(o);c&&e.tracks.forEach(({type:t,keyframes:e})=>{const h=[],u=[];for(const n of e)if(h.push(n.frame/r),t===s.b.Rotation){const t=c.evaluation_flags.zxy_rotation_order?"ZXY":"ZYX",e=(new i.Quaternion).setFromEuler(new i.Euler(n.value.x,n.value.y,n.value.z,t));u.push(e.x,e.y,e.z,e.w)}else u.push(n.value.x,n.value.y,n.value.z);if(t===s.b.Rotation)a.push(new i.QuaternionKeyframeTrack(`.bones[${o}].quaternion`,h,u,n));else{const e=t===s.b.Position?`.bones[${o}].position`:`.bones[${o}].scale`;a.push(new i.VectorKeyframeTrack(e,h,u,n))}})}),new i.AnimationClip("Animation",(e.frame_count-1)/r,a).optimize()}},834:function(t,e,n){"use strict";n.r(e),n.d(e,"ModelRenderer",(function(){return f}));var i=n(136),s=n(579),r=n(660),a=n(628),o=n(545),c=n(549),h=n(15);const u=n(24).a.get("viewer/rendering/ModelRenderer"),l=new i.MeshLambertMaterial({color:16777215,side:i.DoubleSide}),m=new i.MeshLambertMaterial({skinning:!0,color:16777215,side:i.DoubleSide}),_=Object.freeze(new i.Vector3(0,10,20)),p=Object.freeze(new i.Vector3(0,0,0));class f extends c.a{constructor(t,e){super(e),this.store=t,this.disposer=new h.a,this.clock=new i.Clock,this.update_animation_time=!0,this.camera=new i.PerspectiveCamera(75,1,1,200),this.current_character_class_changed=t=>{const e=null!=t.value;this.character_class_active!==e&&this.reset_camera(_,p),this.character_class_active=e},this.nj_object_or_xvm_changed=()=>{var t;this.mesh&&(this.scene.remove(this.mesh),this.mesh=void 0,this.scene.remove(this.skeleton_helper),this.skeleton_helper=void 0);const e=this.store.current_nj_object.val;if(e){let n;if(this.animation){const e=this.animation.mixer;n=null===(t=e.existingAction(this.animation.clip))||void 0===t?void 0:t.time,e.stopAllAction(),e.uncacheAction(this.animation.clip),this.animation=void 0}const c=this.store.current_textures.val.map(t=>{if(t)try{return Object(s.b)(t)}catch(t){u.error("Couldn't convert XVR texture.",t)}}),h=Object(a.a)(e),_=null!=h.getAttribute("skinIndex");this.mesh=Object(r.a)(h,c,_?m:l,_);const p=h.boundingBox,f=p.max.y-p.min.y;this.mesh.translateY(-f/2-p.min.y),this.scene.add(this.mesh),this.skeleton_helper=new i.SkeletonHelper(this.mesh),this.skeleton_helper.visible=this.store.show_skeleton.val,this.skeleton_helper.material.linewidth=3,this.scene.add(this.skeleton_helper);const d=this.store.current_nj_motion.val;if(d){const t=new i.AnimationMixer(this.mesh);t.timeScale=this.store.animation_frame_rate.val/o.a;const s=Object(o.b)(e,d);this.animation={mixer:t,clip:s};const r=t.clipAction(s,this.mesh);r.time=null!=n?n:0,r.play()}}this.schedule_render()},this.nj_motion_changed=({value:t})=>{let e;this.animation&&(this.animation.mixer.stopAllAction(),this.animation.mixer.uncacheAction(this.animation.clip),e=this.animation.mixer);const n=this.store.current_nj_object.val;if(!(this.mesh&&this.mesh instanceof i.SkinnedMesh&&t&&n))return;e||(e=new i.AnimationMixer(this.mesh));const s=Object(o.b)(n,t);this.animation={mixer:e,clip:s},this.clock.start(),e.clipAction(s).play(),this.schedule_render()},this.show_skeleton_changed=({value:t})=>{this.skeleton_helper&&(this.skeleton_helper.visible=t,this.schedule_render())},this.animation_playing_changed=({value:t})=>{this.animation&&(this.animation.mixer.clipAction(this.animation.clip).paused=!t,t?(this.clock.start(),this.schedule_render()):this.clock.stop())},this.animation_frame_rate_changed=({value:t})=>{this.animation&&(this.animation.mixer.timeScale=t/o.a)},this.animation_frame_changed=({value:t})=>{const e=this.store.current_nj_motion.val;if(this.animation&&e){const n=e.frame_count;t>n&&(t=1),t<1&&(t=n),this.update_animation_time&&(this.animation.mixer.clipAction(this.animation.clip).time=(t-1)/o.a),this.schedule_render()}},this.character_class_active=null!=t.current_character_class.val,this.disposer.add_all(t.current_character_class.observe(this.current_character_class_changed),t.current_nj_object.observe(this.nj_object_or_xvm_changed),t.current_textures.observe(this.nj_object_or_xvm_changed),t.current_nj_motion.observe(this.nj_motion_changed),t.show_skeleton.observe(this.show_skeleton_changed),t.animation_playing.observe(this.animation_playing_changed),t.animation_frame_rate.observe(this.animation_frame_rate_changed),t.animation_frame.observe(this.animation_frame_changed)),this.init_camera_controls(),this.reset_camera(_,p)}set_size(t,e){this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),super.set_size(t,e)}dispose(){super.dispose(),this.disposer.dispose()}render(){this.animation&&this.animation.mixer.update(this.clock.getDelta()),this.light_holder.quaternion.copy(this.camera.quaternion),super.render(),this.animation&&!this.animation.mixer.clipAction(this.animation.clip).paused&&(this.update_animation_frame(),this.schedule_render())}update_animation_frame(){if(this.animation){const t=this.animation.mixer.clipAction(this.animation.clip);t.paused||(this.update_animation_time=!1,this.store.set_animation_frame(t.time*o.a+1),this.update_animation_time=!0)}}}}}]);