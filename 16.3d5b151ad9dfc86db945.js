(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{463:function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return o}));const n=2*Math.PI/65536,i=65536/(2*Math.PI);function r(e){return e*n}function o(e){return Math.round(e*i)}},490:function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return o})),s.d(t,"c",(function(){return a}));var n=s(463);const i=1296321870;var r,o;function a(e,t){return e.u32()===i?function(e,t){const s=e.u32();return u(e.take(s),t)}(e,t):(e.seek_start(0),function(e,t){e.seek_end(16);const s=e.u32();e.seek_start(s);const n=e.u32();return e.seek_start(n),function(e,t){e.seek(4);const s=e.u32();return e.seek_start(s),u(e,t)}(e,t)}(e,t))}function u(e,t){let s=e.u32();const n=e.u32(),i=e.u16(),r=e.u16(),a=(192&r)>>6,u=15&r,_=[];for(let r=0;r<t;r++){e.seek_start(s),s=s+=8*u;const t={tracks:[]};_.push(t);const r=[],a=[];for(let t=0;t<u;t++)r.push(e.u32());for(let t=0;t<u;t++){const t=e.u32();a.push(t)}if(1&i){e.seek_start(r.shift());const s=a.shift();s&&t.tracks.push({type:o.Position,keyframes:c(e,s)})}if(2&i){e.seek_start(r.shift());const s=a.shift();s&&t.tracks.push({type:o.Rotation,keyframes:l(e,s,n)})}if(4&i){e.seek_start(r.shift());const s=a.shift();s&&t.tracks.push({type:o.Scale,keyframes:c(e,s)})}}return{motion_data:_,frame_count:n,type:i,interpolation:a,element_count:u}}function c(e,t){const s=[];for(let n=0;n<t;++n)s.push({frame:e.u32(),value:e.vec3_f32()});return s}function l(e,t,s){const i=[],r=e.position;for(let s=0;s<t;++s)i.push({frame:e.u16(),value:{x:Object(n.a)(e.u16()),y:Object(n.a)(e.u16()),z:Object(n.a)(e.u16())}});let o=-1;for(const{frame:n}of i){if(n<o||n>=s)return e.seek_start(r),_(e,t);o=n}return i}function _(e,t){const s=[];for(let i=0;i<t;++i)s.push({frame:e.u32(),value:{x:Object(n.a)(e.i32()),y:Object(n.a)(e.i32()),z:Object(n.a)(e.i32())}});return s}!function(e){e[e.Linear=0]="Linear",e[e.Spline=1]="Spline",e[e.UserFunction=2]="UserFunction"}(r||(r={})),function(e){e[e.Position=0]="Position",e[e.Rotation=1]="Rotation",e[e.Scale=2]="Scale"}(o||(o={}))},512:function(e,t,s){"use strict";s.d(t,"a",(function(){return v})),s.d(t,"b",(function(){return y})),s.d(t,"c",(function(){return g})),s.d(t,"d",(function(){return j}));var n=s(511),i=s(23);const r=i.a.get("core/data_formats/parsing/ninja/njcm");var o;function a(e,t){const s=e.u32(),n=e.u32(),i=e.vec3_f32(),r=e.f32(),a=[],c=[];if(s){e.seek_start(s);for(const s of u(e,t,!0))if(s.type===o.Vertex)for(const e of s.vertices)a[e.index]={position:e.position,normal:e.normal,bone_weight:e.bone_weight,bone_weight_status:e.bone_weight_status,calc_continue:e.calc_continue}}if(n){e.seek_start(n);let s=void 0,i=void 0,r=void 0;for(const n of u(e,t,!1))switch(n.type){case o.Bits:i=n.src_alpha,r=n.dst_alpha;break;case o.Tiny:s=n.texture_id;break;case o.Material:i=n.src_alpha,r=n.dst_alpha;break;case o.Strip:for(const e of n.triangle_strips)e.texture_id=s,e.src_alpha=i,e.dst_alpha=r;c.push(...n.triangle_strips)}}return{type:"njcm",vertices:a,meshes:c,collision_sphere_center:i,collision_sphere_radius:r}}function u(e,t,s){const n=[];let i=!0;for(;i;){const a=e.u8(),_=e.u8(),f=e.position;let h=0;if(0===a)n.push({type:o.Null,type_id:a});else if(1<=a&&a<=3)n.push({type:o.Bits,type_id:a,src_alpha:_>>>3&7,dst_alpha:7&_});else if(4===a){const s=_,r=e.position;n.push({type:o.CachePolygonList,type_id:a,cache_index:s,offset:r}),t[s]=r,i=!1}else if(5===a){const i=_,r=t[i];null!=r&&(e.seek_start(r),n.push(...u(e,t,s))),n.push({type:o.DrawPolygonList,type_id:a,cache_index:i})}else if(8<=a&&a<=9){h=2;const t=e.u16();n.push({type:o.Tiny,type_id:a,flip_u:0!=(128&a),flip_v:0!=(64&a),clamp_u:0!=(32&a),clamp_v:0!=(16&a),mipmap_d_adjust:15&a,filter_mode:t>>>14,super_sample:0!=(64&t),texture_id:8191&t})}else if(17<=a&&a<=31){let t,s,i;h=2+2*e.u16(),0!=(1&_)&&(t={b:e.u8()/255,g:e.u8()/255,r:e.u8()/255,a:e.u8()/255}),0!=(2&_)&&(s={b:e.u8()/255,g:e.u8()/255,r:e.u8()/255,a:e.u8()/255}),0!=(4&_)&&(i={b:e.u8(),g:e.u8(),r:e.u8(),e:e.u8()}),n.push({type:o.Material,type_id:a,src_alpha:_>>>3&7,dst_alpha:7&_,diffuse:t,ambient:s,specular:i})}else 32<=a&&a<=50?(h=2+4*e.u16(),n.push({type:o.Vertex,type_id:a,vertices:c(e,a,_)})):56<=a&&a<=58?(h=2+2*e.u16(),n.push({type:o.Volume,type_id:a})):64<=a&&a<=75?(h=2+2*e.u16(),n.push({type:o.Strip,type_id:a,triangle_strips:l(e,a,_)})):255===a?(h=s?2:0,n.push({type:o.End,type_id:a}),i=!1):(h=2+2*e.u16(),n.push({type:o.Unknown,type_id:a}),r.warn(`Unknown chunk type ${a} at offset ${f}.`));e.seek_start(f+h)}return n}function c(e,t,s){if(t<32||t>50)return r.warn(`Unknown vertex chunk type ${t}.`),[];const n=3&s,i=0!=(128&s),o=e.u16(),a=e.u16(),u=[];for(let s=0;s<a;++s){const r={index:o+s,position:e.vec3_f32(),bone_weight:1,bone_weight_status:n,calc_continue:i};if(32===t)e.seek(4);else if(33===t)e.seek(4),r.normal=e.vec3_f32(),e.seek(4);else if(35<=t&&t<=40)37===t?(r.index=o+e.u16(),r.bone_weight=e.u16()/255):e.seek(4);else if(41<=t&&t<=47)r.normal=e.vec3_f32(),t>=42&&(44===t?(r.index=o+e.u16(),r.bone_weight=e.u16()/255):e.seek(4));else if(48<=t&&t<=50){const s=e.u32();r.normal={x:(s>>20&1023)/1023,y:(s>>10&1023)/1023,z:(1023&s)/1023},t>=49&&e.seek(4)}u.push(r)}return u}function l(e,t,s){const n={ignore_light:0!=(1&s),ignore_specular:0!=(2&s),ignore_ambient:0!=(4&s),use_alpha:0!=(8&s),double_side:0!=(16&s),flat_shading:0!=(32&s),environment_mapping:0!=(64&s)},i=e.u16(),r=i>>>14,o=16383&i;let a=!1,u=!1,c=!1,l=!1;switch(t){case 64:break;case 65:case 66:a=!0;break;case 67:c=!0;break;case 68:case 69:a=!0,c=!0;break;case 70:u=!0;break;case 71:case 72:a=!0,u=!0;break;case 73:break;case 74:case 75:l=!0;break;default:throw new Error(`Unexpected chunk type ID: ${t}.`)}const _=[];for(let t=0;t<o;++t){const t=e.i16(),s=t<1,i=Math.abs(t),o=[];for(let t=0;t<i;++t){const s={index:e.u16()};o.push(s),a&&(s.tex_coords={x:e.u16()/255,y:e.u16()/255}),u&&e.seek(4),c&&(s.normal={x:e.u16()/255,y:e.u16()/255,z:e.u16()/255}),l&&e.seek(8),t>=2&&e.seek(2*r)}_.push(Object.assign(Object.assign({},n),{clockwise_winding:s,has_tex_coords:a,has_normal:c,vertices:o}))}return _}!function(e){e[e.Unknown=0]="Unknown",e[e.Null=1]="Null",e[e.Bits=2]="Bits",e[e.CachePolygonList=3]="CachePolygonList",e[e.DrawPolygonList=4]="DrawPolygonList",e[e.Tiny=5]="Tiny",e[e.Material=6]="Material",e[e.Vertex=7]="Vertex",e[e.Volume=8]="Volume",e[e.Strip=9]="Strip",e[e.End=10]="End"}(o||(o={}));const _=i.a.get("core/data_formats/parsing/ninja/xj");function f(e){e.seek(4);const t=e.u32(),s=e.u32(),n=e.u32(),i=e.u32(),r=e.u32(),o=e.u32(),a={type:"xj",vertices:[],meshes:[],collision_sphere_position:e.vec3_f32(),collision_sphere_radius:e.f32()};return s>=1&&a.vertices.push(...function(e,t){e.seek_start(t);const s=e.u16();e.seek(2);const n=e.u32(),i=e.u32(),r=e.u32(),o=[];for(let t=0;t<r;++t){e.seek_start(n+t*i);const r=e.vec3_f32();let a,u;switch(s){case 3:a=e.vec3_f32(),u=e.vec2_f32();break;case 4:break;case 5:e.seek(4),u=e.vec2_f32();break;case 6:a=e.vec3_f32();break;case 7:a=e.vec3_f32(),u=e.vec2_f32();break;default:_.warn(`Unknown vertex type ${s} with size ${i}.`)}o.push({position:r,normal:a,uv:u})}return o}(e,t)),a.meshes.push(...h(e,n,i)),a.meshes.push(...h(e,r,o)),a}function h(e,t,s){const n=[];for(let i=0;i<s;++i){e.seek_start(t+20*i);const s=e.u32(),r=e.u32(),o=e.u32(),a=e.u32(),u=p(e,s,r);e.seek_start(o);const c=e.u16_array(a);n.push({material_properties:u,indices:c})}return n}function p(e,t,s){const n={};for(let i=0;i<s;++i){switch(e.seek_start(t+16*i),e.u32()){case 2:n.src_alpha=e.u32(),n.dst_alpha=e.u32();break;case 3:n.texture_id=e.u32();break;case 5:n.diffuse_r=e.u8(),n.diffuse_g=e.u8(),n.diffuse_b=e.u8(),n.diffuse_a=e.u8()}}return n}var d=s(462),b=s(463);const m=1296255566;function v(e){return"njcm"===e.type}class k{constructor(e,t,s,n,i,r){this.evaluation_flags=e,this.model=t,this.position=s,this.rotation=n,this.scale=i,this._children=r,this.children=this._children}bone_count(){const e=[0];return this.get_bone_internal(this,Number.MAX_SAFE_INTEGER,e),e[0]}get_bone(e){return this.get_bone_internal(this,e,[0])}add_child(e){this._children.push(e)}clear_children(){this._children.splice(0)}get_bone_internal(e,t,s){if(!e.evaluation_flags.skip){if(s[0]++===t)return e}if(!e.evaluation_flags.break_child_trace)for(const n of e.children){const e=this.get_bone_internal(n,t,s);if(e)return e}}}function y(e){return w(e,a,[])}function g(e){return w(e,f,void 0)}function j(e){return x(e,f,void 0)}function w(e,t,s){const i=Object(n.a)(e);if(!i.success)return i;const r=i.value.filter(e=>e.type===m),o=[];for(const e of r)o.push(...x(e.data,t,s));return Object(d.c)(o,i.problems)}function x(e,t,s){const n=e.u32(),i=0!=(1&n),r=0!=(2&n),o=0!=(4&n),a=0!=(8&n),u=0!=(16&n),c=0!=(32&n),l=0!=(64&n),_=0!=(128&n),f=e.u32(),h=e.vec3_f32(),p={x:Object(b.a)(e.i32()),y:Object(b.a)(e.i32()),z:Object(b.a)(e.i32())},d=e.vec3_f32(),m=e.u32(),v=e.u32();let y,g,j;return f&&(e.seek_start(f),y=t(e,s)),m?(e.seek_start(m),g=x(e,t,s)):g=[],v?(e.seek_start(v),j=x(e,t,s)):j=[],[new k({no_translate:i,no_rotate:r,no_scale:o,hidden:a,break_child_trace:u,zxy_rotation_order:c,skip:l,shape_skip:_},y,h,p,d,g),...j]}},543:function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(23),i=s(462),r=s(27);const o=n.a.get("core/data_formats/parsing/afs"),a=5457473;function u(e){const t=Object(i.b)(o);if(e.bytes_left<8)return t.add_problem(r.b.Error,"AFS archive is corrupted.","Too small to be an AFS archive.").failure();if(e.u32()!==a)return t.add_problem(r.b.Error,"AFS archive is corrupted.","Magic bytes not present.").failure();const s=e.u16();e.seek(2);const n=[];for(let i=1;i<=s;i++){if(e.bytes_left<8){t.add_problem(r.b.Warning,`AFS file entry ${i} is invalid.`,`Couldn't read file entry ${i}, only ${e.bytes_left} bytes left.`);break}const s=e.u32(),o=e.u32();if(s>e.size)t.add_problem(r.b.Warning,`AFS file entry ${i} is invalid.`,`Invalid file offset ${s} for entry ${i}.`);else if(s+o>e.size)t.add_problem(r.b.Warning,`AFS file entry ${i} is invalid.`,`File size ${o} (offset: ${s}) of entry ${i} too large.`);else{const t=e.position;e.seek_start(s),n.push(e.array_buffer(o)),e.seek_start(t)}}return t.success(n)}},829:function(e,t,s){"use strict";s.r(t),s.d(t,"ModelToolBarController",(function(){return v}));var n=s(140),i=s(500),r=s(468),o=s(456),a=s(512),u=s(490),c=s(539),l=s(543),_=s(23),f=s(628),h=s(462),p=s(27),d=s(14),b=function(e,t,s,n){return new(s||(s=Promise))((function(i,r){function o(e){try{u(n.next(e))}catch(e){r(e)}}function a(e){try{u(n.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};const m=_.a.get("viewer/controllers/model/ModelToolBarController");class v extends n.a{constructor(e){super(),this.store=e,this._result_dialog_visible=Object(d.e)(!1),this._result=Object(d.e)(void 0),this._result_problems_message=Object(d.e)(""),this._result_error_message=Object(d.e)(""),this.result_dialog_visible=this._result_dialog_visible,this.result=this._result,this.result_problems_message=this._result_problems_message,this.result_error_message=this._result_error_message,this.set_show_skeleton=e=>{this.store.set_show_skeleton(e)},this.set_animation_playing=e=>{this.store.set_animation_playing(e)},this.set_animation_frame_rate=e=>{this.store.set_animation_frame_rate(e)},this.set_animation_frame=e=>{this.store.set_animation_frame(e)},this.load_file=e=>b(this,void 0,void 0,(function*(){this._result_problems_message.val=`Encountered some problems while opening "${e.name}".`,this._result_error_message.val=`Couldn't open "${e.name}".`;try{const t=yield Object(i.b)(e),s=new r.a(t,o.a.Little);if(e.name.endsWith(".nj")){const e=Object(a.b)(s);this.set_result(e),e.success&&this.store.set_current_nj_object(e.value[0])}else if(e.name.endsWith(".xj")){const e=Object(a.c)(s);this.set_result(e),e.success&&this.store.set_current_nj_object(e.value[0])}else if(e.name.endsWith(".njm")){this.store.set_current_animation(void 0),this.store.set_current_nj_motion(void 0);const e=this.store.current_nj_object.val;e?(this.set_animation_playing(!0),this.store.set_current_nj_motion(Object(u.c)(s,e.bone_count())),this.set_result(Object(h.c)(void 0))):this.set_result(Object(h.a)([{severity:p.b.Error,ui_message:"No model to animate"}]))}else if(e.name.endsWith(".xvm")){const e=Object(c.b)(s);this.set_result(e),e.success?this.store.set_current_textures(e.value.textures):this.store.set_current_textures([])}else if(e.name.endsWith(".afs")){const e=Object(h.b)(m),t=Object(l.a)(s);if(e.add_result(t),t.success){const s=t.value.flatMap(t=>{var s,n,i,a;const u=new r.a(t,o.a.Little);if(Object(c.a)(u)){const t=Object(c.b)(u);return e.add_result(t),null!==(n=null===(s=t.value)||void 0===s?void 0:s.textures)&&void 0!==n?n:[]}{const t=Object(c.b)(Object(f.a)(u.seek_start(0)));return e.add_result(t),null!==(a=null===(i=t.value)||void 0===i?void 0:i.textures)&&void 0!==a?a:[]}});s.length?this.set_result(e.success(s)):this.set_result(e.failure()),this.store.set_current_textures(s)}else this.set_result(e.failure())}else m.debug(`Unsupported file extension in filename "${e.name}".`),this.set_result(Object(h.a)([{severity:p.b.Error,ui_message:"Unsupported file type."}]))}catch(e){m.error("Couldn't read file.",e),this.set_result(Object(h.a)())}})),this.dismiss_result_dialog=()=>{this._result_dialog_visible.val=!1},this.show_skeleton=e.show_skeleton,this.animation_frame_count=e.animation_frame_count,this.animation_frame_count_label=e.animation_frame_count.map(e=>`/ ${e}`),this.animation_controls_enabled=e.current_nj_motion.map(e=>null!=e),this.animation_playing=e.animation_playing,this.animation_frame_rate=e.animation_frame_rate,this.animation_frame=e.animation_frame.map(e=>Math.round(e))}set_result(e){this._result.val=e,e.problems.length&&(this._result_dialog_visible.val=!0)}}}}]);