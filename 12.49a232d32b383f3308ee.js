(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{525:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var n=i(589),s=i(136);n.a.install({THREE:Object.assign(Object.assign({},s),{MOUSE:Object.assign(Object.assign({},s.MOUSE),{LEFT:s.MOUSE.RIGHT,RIGHT:s.MOUSE.LEFT})})});class r{constructor(e){this._debug=!1,this.scene=new s.Scene,this.light_holder=new s.Group,this.render_scheduled=!1,this.animation_frame_handle=void 0,this.light=new s.HemisphereLight(16777215,5263440,1),this.controls_clock=new s.Clock,this.size=new s.Vector2(0,0),this.schedule_render=()=>{this.render_scheduled=!0},this.on_mouse_down=e=>{e.currentTarget&&e.currentTarget.focus()},this.call_render=()=>{const e=this.controls.update(this.controls_clock.getDelta()),t=this.render_scheduled||e;this.render_scheduled=!1,t&&this.render(),this.animation_frame_handle=requestAnimationFrame(this.call_render)},this.renderer=e,this.renderer.domElement.tabIndex=0,this.renderer.domElement.addEventListener("mousedown",this.on_mouse_down),this.renderer.domElement.style.outline="none",this.scene.background=new s.Color(1579032),this.light_holder.add(this.light),this.scene.add(this.light_holder)}get debug(){return this._debug}set debug(e){this._debug=e}get canvas_element(){return this.renderer.domElement}set_size(e,t){this.size.set(e,t),this.renderer.setSize(e,t),this.schedule_render()}pointer_pos_to_device_coords(e){e.set(e.x/this.size.width*2-1,e.y/this.size.height*-2+1)}start_rendering(){null==this.animation_frame_handle&&(this.schedule_render(),this.animation_frame_handle=requestAnimationFrame(this.call_render))}stop_rendering(){null!=this.animation_frame_handle&&(cancelAnimationFrame(this.animation_frame_handle),this.animation_frame_handle=void 0)}reset_camera(e,t){this.controls.setLookAt(e.x,e.y,e.z,t.x,t.y,t.z)}dispose(){this.renderer.dispose(),this.controls.dispose()}init_camera_controls(){this.controls=new n.a(this.camera,this.renderer.domElement),this.controls.dampingFactor=1,this.controls.draggingDampingFactor=1}render(){this.renderer.render(this.scene,this.camera)}}},526:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var n=i(136);function s(e){return new n.Vector3(e.x,e.y,e.z)}},540:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return r}));var n=i(136);function s(e){return e.textures.map(r)}function r(e){let t,i;switch(e.format[1]){case 6:t=n.RGBA_S3TC_DXT1_Format,i=e.width*e.height/2;break;case 7:t=n.RGBA_S3TC_DXT3_Format,i=e.width*e.height;break;default:throw new Error(`Format ${e.format.join(", ")} not supported.`)}const s=new n.CompressedTexture([{data:new Uint8Array(e.data,0,i),width:e.width,height:e.height}],e.width,e.height,t);return s.minFilter=n.LinearFilter,s.wrapS=n.MirroredRepeatWrapping,s.wrapT=n.MirroredRepeatWrapping,s.needsUpdate=!0,s}},546:function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return o}));var n=i(136),s=i(544);const r=30;function o(e,t){const i=t.interpolation===s.a.Spline?n.InterpolateSmooth:n.InterpolateLinear,o=[];return t.motion_data.forEach((t,a)=>{const h=e.get_bone(a);h&&t.tracks.forEach(({type:e,keyframes:t})=>{const c=[],l=[];for(const i of t)if(c.push(i.frame/r),e===s.b.Rotation){const e=h.evaluation_flags.zxy_rotation_order?"ZXY":"ZYX",t=(new n.Quaternion).setFromEuler(new n.Euler(i.value.x,i.value.y,i.value.z,e));l.push(t.x,t.y,t.z,t.w)}else l.push(i.value.x,i.value.y,i.value.z);if(e===s.b.Rotation)o.push(new n.QuaternionKeyframeTrack(`.bones[${a}].quaternion`,c,l,i));else{const t=e===s.b.Position?`.bones[${a}].position`:`.bones[${a}].scale`;o.push(new n.VectorKeyframeTrack(t,c,l,i))}})}),new n.AnimationClip("Animation",(t.frame_count-1)/r,o).optimize()}},579:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var n=i(136),s=i(40);class r{constructor(){this.materials=[{alpha:!1,additive_blending:!1}],this.map=new Map}add_material(e,t=!1,i=!1){if(null==e)return 0;{const n=e<<2|(t?2:0)|(i?1:0);return Object(s.i)(this.map,n,()=>(this.materials.push({texture_id:e,alpha:t,additive_blending:i}),this.materials.length-1))}}get_materials(){return this.materials}}class o{constructor(){this.positions=[],this.normals=[],this.uvs=[],this.indices=[],this.bones=[],this.bone_indices=[],this.bone_weights=[],this.groups=[],this.material_map=new r}get vertex_count(){return this.positions.length/3}get index_count(){return this.indices.length}get_position(e){return new n.Vector3(this.positions[3*e],this.positions[3*e+1],this.positions[3*e+2])}get_normal(e){return new n.Vector3(this.normals[3*e],this.normals[3*e+1],this.normals[3*e+2])}add_vertex(e,t,i){this.positions.push(e.x,e.y,e.z),this.normals.push(t.x,t.y,t.z),this.uvs.push(i.x,i.y)}add_index(e){this.indices.push(e)}add_bone(e){this.bones.push(e)}add_bone_weight(e,t){this.bone_indices.push(e),this.bone_weights.push(t)}add_group(e,t,i,n=!1,s=!1){const r=this.groups[this.groups.length-1],o=this.material_map.add_material(i,n,s);r&&r.material_index===o?r.size+=t:this.groups.push({offset:e,size:t,material_index:o})}build(){const e=new n.BufferGeometry;let t;e.setAttribute("position",new n.Float32BufferAttribute(this.positions,3)),e.setAttribute("normal",new n.Float32BufferAttribute(this.normals,3)),e.setAttribute("uv",new n.Float32BufferAttribute(this.uvs,2)),e.setIndex(new n.Uint16BufferAttribute(this.indices,1)),this.bone_indices.length&&this.bones.length?(e.setAttribute("skinIndex",new n.Uint16BufferAttribute(this.bone_indices,4)),e.setAttribute("skinWeight",new n.Float32BufferAttribute(this.bone_weights,4)),t=this.bones):t=[];for(const t of this.groups)e.addGroup(t.offset,t.size,t.material_index);const i={created_by_geometry_builder:!0,materials:this.material_map.get_materials(),bones:t};return e.userData=i,e.computeBoundingSphere(),e.computeBoundingBox(),e}}},580:function(e,t,i){"use strict";i.d(t,"b",(function(){return _})),i.d(t,"a",(function(){return u}));var n=i(136),s=i(526),r=i(499),o=i(579);const a=new n.Vector3(0,1,0),h=new n.Vector2(0,0),c=new n.Vector3(0,0,0),l=new n.Quaternion(0,0,0,1),d=new n.Vector3(1,1,1);function _(e,t){new p(t).to_geometry_builder(e)}function u(e){return new p(new o.a).create_buffer_geometry(e)}class m{constructor(){this.vertices_stack=[]}put(e){this.vertices_stack.push(e)}get(e){const t=[];for(let i=this.vertices_stack.length-1;i>=0;i--){const n=this.vertices_stack[i][e];n&&t.push(n)}return t}}class p{constructor(e){this.vertices=new m,this.bone_id=0,this.builder=e}to_geometry_builder(e){this.object_to_geometry(e,void 0,new n.Matrix4)}create_buffer_geometry(e){return this.to_geometry_builder(e),this.builder.build()}object_to_geometry(e,t,i){const{no_translate:r,no_rotate:o,no_scale:a,hidden:h,break_child_trace:_,zxy_rotation_order:u,skip:m}=e.evaluation_flags,{position:p,rotation:b,scale:g}=e,f=new n.Euler(b.x,b.y,b.z,u?"ZXY":"ZYX"),w=(new n.Matrix4).compose(r?c:Object(s.a)(p),o?l:(new n.Quaternion).setFromEuler(f),a?d:Object(s.a)(g)).premultiply(i);let x;if(m?x=t:(x=new n.Bone,x.name=this.bone_id.toString(),x.position.set(p.x,p.y,p.z),x.setRotationFromEuler(f),x.scale.set(g.x,g.y,g.z),this.builder.add_bone(x),t&&t.add(x)),e.model&&!h&&this.model_to_geometry(e.model,w),this.bone_id++,!_)for(const t of e.children)this.object_to_geometry(t,x,w)}model_to_geometry(e,t){Object(r.b)(e)?this.njcm_model_to_geometry(e,t):this.xj_model_to_geometry(e,t)}njcm_model_to_geometry(e,t){var i,r;const o=(new n.Matrix3).getNormalMatrix(t),c=e.vertices.map(e=>{const i=Object(s.a)(e.position),r=e.normal?Object(s.a)(e.normal):new n.Vector3(0,1,0);return i.applyMatrix4(t),r.applyMatrix3(o),{bone_id:this.bone_id,position:i,normal:r,bone_weight:e.bone_weight,bone_weight_status:e.bone_weight_status,calc_continue:e.calc_continue}});this.vertices.put(c);for(const t of e.meshes){const e=this.builder.index_count;for(let e=0;e<t.vertices.length;++e){const n=t.vertices[e],s=this.vertices.get(n.index);if(s.length){const o=s[0],c=null!==(r=null!==(i=o.normal)&&void 0!==i?i:n.normal)&&void 0!==r?r:a,l=this.builder.vertex_count;this.builder.add_vertex(o.position,c,t.has_tex_coords?n.tex_coords:h),e>=2&&(e%2==(t.clockwise_winding?1:0)?(this.builder.add_index(l-2),this.builder.add_index(l-1),this.builder.add_index(l)):(this.builder.add_index(l-2),this.builder.add_index(l),this.builder.add_index(l-1)));const d=[[0,0],[0,0],[0,0],[0,0]];for(let e=s.length-1;e>=0;e--){const t=s[e];d[t.bone_weight_status]=[t.bone_id,t.bone_weight]}const _=d.reduce((e,[,t])=>e+t,0);for(const[e,t]of d)this.builder.add_bone_weight(e,_>0?t/_:t)}}this.builder.add_group(e,this.builder.index_count-e,t.texture_id,t.use_alpha,4!==t.src_alpha||5!==t.dst_alpha)}}xj_model_to_geometry(e,t){const i=this.builder.vertex_count,r=(new n.Matrix3).getNormalMatrix(t);for(const{position:i,normal:o,uv:a}of e.vertices){const e=Object(s.a)(i).applyMatrix4(t),c=(o?Object(s.a)(o):new n.Vector3(0,1,0)).applyMatrix3(r),l=a||h;this.builder.add_vertex(e,c,l)}let o,a,c;for(const t of e.meshes){const e=this.builder.index_count;let n=!1;for(let e=2;e<t.indices.length;++e){const s=i+t.indices[e-2],r=i+t.indices[e-1],o=i+t.indices[e],a=this.builder.get_position(s),h=this.builder.get_position(r),c=this.builder.get_position(o),l=this.builder.get_normal(s),d=this.builder.get_normal(r),_=this.builder.get_normal(o),u=h.clone().sub(a).cross(c.clone().sub(a));n&&u.negate(),(u.dot(l)<0?1:0)+(u.dot(d)<0?1:0)+(u.dot(_)<0?1:0)>=2&&(n=!n),n?(this.builder.add_index(r),this.builder.add_index(s),this.builder.add_index(o)):(this.builder.add_index(s),this.builder.add_index(r),this.builder.add_index(o)),n=!n}null!=t.material_properties.texture_id&&(o=t.material_properties.texture_id),null!=t.material_properties.src_alpha&&(a=t.material_properties.src_alpha),null!=t.material_properties.dst_alpha&&(c=t.material_properties.dst_alpha),this.builder.add_group(e,this.builder.index_count-e,o,!0,4!==a||5!==c)}}}},590:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var n=i(136);const s=new n.MeshLambertMaterial({color:65280,side:n.DoubleSide});function r(e,t,i,r){const{created_by_geometry_builder:o,materials:a,bones:h}=e.userData;let c;if(t.length&&o){c=[s];for(let e=1;e<a.length;e++){const{texture_id:i,alpha:s,additive_blending:o}=a[e],h=null==i?void 0:t[i];if(h){const e={skinning:r,map:h,side:n.DoubleSide};s&&(e.transparent=!0,e.alphaTest=.01),o&&(e.transparent=!0,e.alphaTest=.01,e.blending=n.AdditiveBlending),c.push(new n.MeshBasicMaterial(e))}else c.push(new n.MeshLambertMaterial({skinning:r,side:n.DoubleSide}))}}else c=i;if(o&&h.length&&r){const t=new n.SkinnedMesh(e,c);return t.add(h[0]),t.bind(new n.Skeleton(h)),t}return new n.Mesh(e,c)}},831:function(e,t,i){"use strict";i.r(t),i.d(t,"ModelRenderer",(function(){return p}));var n=i(136),s=i(540),r=i(590),o=i(580),a=i(546),h=i(525),c=i(15);const l=i(23).a.get("viewer/rendering/ModelRenderer"),d=new n.MeshLambertMaterial({color:16777215,side:n.DoubleSide}),_=new n.MeshLambertMaterial({skinning:!0,color:16777215,side:n.DoubleSide}),u=Object.freeze(new n.Vector3(0,10,20)),m=Object.freeze(new n.Vector3(0,0,0));class p extends h.a{constructor(e,t){super(t),this.store=e,this.disposer=new c.a,this.clock=new n.Clock,this.update_animation_time=!0,this.camera=new n.PerspectiveCamera(75,1,1,200),this.current_character_class_changed=e=>{const t=null!=e.value;this.character_class_active!==t&&this.reset_camera(u,m),this.character_class_active=t},this.nj_object_or_xvm_changed=()=>{var e;this.mesh&&(this.scene.remove(this.mesh),this.mesh=void 0,this.scene.remove(this.skeleton_helper),this.skeleton_helper=void 0);const t=this.store.current_nj_object.val;if(t){let i;if(this.animation){const t=this.animation.mixer;i=null===(e=t.existingAction(this.animation.clip))||void 0===e?void 0:e.time,t.stopAllAction(),t.uncacheAction(this.animation.clip),this.animation=void 0}const h=this.store.current_textures.val.map(e=>{if(e)try{return Object(s.b)(e)}catch(e){l.error("Couldn't convert XVR texture.",e)}}),c=Object(o.a)(t),u=null!=c.getAttribute("skinIndex");this.mesh=Object(r.a)(c,h,u?_:d,u);const m=c.boundingBox,p=m.max.y-m.min.y;this.mesh.translateY(-p/2-m.min.y),this.scene.add(this.mesh),this.skeleton_helper=new n.SkeletonHelper(this.mesh),this.skeleton_helper.visible=this.store.show_skeleton.val,this.skeleton_helper.material.linewidth=3,this.scene.add(this.skeleton_helper);const b=this.store.current_nj_motion.val;if(b){const e=new n.AnimationMixer(this.mesh);e.timeScale=this.store.animation_frame_rate.val/a.a;const s=Object(a.b)(t,b);this.animation={mixer:e,clip:s};const r=e.clipAction(s,this.mesh);r.time=null!=i?i:0,r.play()}}this.schedule_render()},this.nj_motion_changed=({value:e})=>{let t;this.animation&&(this.animation.mixer.stopAllAction(),this.animation.mixer.uncacheAction(this.animation.clip),t=this.animation.mixer);const i=this.store.current_nj_object.val;if(!(this.mesh&&this.mesh instanceof n.SkinnedMesh&&e&&i))return;t||(t=new n.AnimationMixer(this.mesh));const s=Object(a.b)(i,e);this.animation={mixer:t,clip:s},this.clock.start(),t.clipAction(s).play(),this.schedule_render()},this.show_skeleton_changed=({value:e})=>{this.skeleton_helper&&(this.skeleton_helper.visible=e,this.schedule_render())},this.animation_playing_changed=({value:e})=>{this.animation&&(this.animation.mixer.clipAction(this.animation.clip).paused=!e,e?(this.clock.start(),this.schedule_render()):this.clock.stop())},this.animation_frame_rate_changed=({value:e})=>{this.animation&&(this.animation.mixer.timeScale=e/a.a)},this.animation_frame_changed=({value:e})=>{const t=this.store.current_nj_motion.val;if(this.animation&&t){const i=t.frame_count;e>i&&(e=1),e<1&&(e=i),this.update_animation_time&&(this.animation.mixer.clipAction(this.animation.clip).time=(e-1)/a.a),this.schedule_render()}},this.character_class_active=null!=e.current_character_class.val,this.disposer.add_all(e.current_character_class.observe(this.current_character_class_changed),e.current_nj_object.observe(this.nj_object_or_xvm_changed),e.current_textures.observe(this.nj_object_or_xvm_changed),e.current_nj_motion.observe(this.nj_motion_changed),e.show_skeleton.observe(this.show_skeleton_changed),e.animation_playing.observe(this.animation_playing_changed),e.animation_frame_rate.observe(this.animation_frame_rate_changed),e.animation_frame.observe(this.animation_frame_changed)),this.init_camera_controls(),this.reset_camera(u,m)}set_size(e,t){this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),super.set_size(e,t)}dispose(){super.dispose(),this.disposer.dispose()}render(){this.animation&&this.animation.mixer.update(this.clock.getDelta()),this.light_holder.quaternion.copy(this.camera.quaternion),super.render(),this.animation&&!this.animation.mixer.clipAction(this.animation.clip).paused&&(this.update_animation_frame(),this.schedule_render())}update_animation_frame(){if(this.animation){const e=this.animation.mixer.clipAction(this.animation.clip);e.paused||(this.update_animation_time=!1,this.store.set_animation_frame(e.time*a.a+1),this.update_animation_time=!0)}}}}}]);